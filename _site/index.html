<!DOCTYPE html>
<html>
<head>
    <meta charset='utf-8'>
    <meta http-equiv="X-UA-Compatible" content="chrome=1">
    <link href='https://fonts.googleapis.com/css?family=Chivo:900' rel='stylesheet' type='text/css'>
    <link rel="stylesheet" type="text/css" href="stylesheets/stylesheet.css" media="screen" />
    <link rel="stylesheet" type="text/css" href="stylesheets/pygment_trac.css" media="screen" />
    <link rel="stylesheet" type="text/css" href="stylesheets/print.css" media="print" />
    <!--[if lt IE 9]>
    <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <title>Jailkit Quickstart by prikha</title>
</head>

<body>
<div id="container">
    <div class="inner">

        <header>
            <h1>Jailkit Quickstart</h1>
            <h2>How to setup a jailed user and deploy your apps secure.</h2>
        </header>

        <section id="pages" class="clearfix">
            <a href="/">Home</a> |
            <a href="/agent-forwarding.html">Agent Forwarding</a> |
            <a href="/jk-init.html">Jk Init Config</a> |
            <a href="/install-node.html">Node.js</a>

        </section>

        <hr>

        <section id="main_content">
            <h2>Bootstrapping</h2>

<h3>Ставим чистую виртуалку Debian 7.4</h3>

<p>Воспользуемся <a href="http://vagrantup.com">Vagrant</a></p>
<div class="highlight"><pre><code class="sh language-sh" data-lang="sh"><span class="nv">$ </span>mkdir debian_with_jail
<span class="nv">$ </span><span class="nb">cd </span>debian_with_jail/
<span class="nv">$ </span>vagrant init InFog/debian74_x64
<span class="nv">$ </span>vagrant up
</code></pre></div>
<p>Теперь нам необходимо слегка поправить Vagrantfile:
important! это надо разделить на два и своевременно вкинуть.</p>
<div class="highlight"><pre><code class="ruby language-ruby" data-lang="ruby"><span class="o">.</span><span class="n">.</span><span class="o">.</span>
<span class="no">Vagrant</span><span class="o">.</span><span class="n">configure</span><span class="p">(</span><span class="no">VAGRANTFILE_API_VERSION</span><span class="p">)</span> <span class="k">do</span> <span class="o">|</span><span class="n">config</span><span class="o">|</span>
  <span class="o">.</span><span class="n">.</span><span class="o">.</span>
  <span class="n">config</span><span class="o">.</span><span class="n">vm</span><span class="o">.</span><span class="n">network</span> <span class="s2">&quot;forwarded_port&quot;</span><span class="p">,</span> <span class="ss">guest</span><span class="p">:</span> <span class="mi">80</span><span class="p">,</span> <span class="ss">host</span><span class="p">:</span> <span class="mi">8080</span>
  <span class="n">config</span><span class="o">.</span><span class="n">ssh</span><span class="o">.</span><span class="n">forward_agent</span> <span class="o">=</span> <span class="kp">true</span>
<span class="k">end</span>
</code></pre></div>
<h3>Готовим jail на удаленном сервере</h3>

<p>Заходим под обычным пользователем и ставим <a href="http://olivier.sessink.nl/jailkit/">jailkit</a>.</p>
<div class="highlight"><pre><code class="sh language-sh" data-lang="sh">vagrant@debian<span class="nv">$ </span>mkdir tmp <span class="o">&amp;&amp;</span> <span class="nb">cd </span>tmp
vagrant@debian<span class="nv">$ </span>wget http://olivier.sessink.nl/jailkit/jailkit-2.17.tar.gz
vagrant@debian<span class="nv">$ </span>tar -zxvf jailkit-2.17.tar.gz
vagrant@debian<span class="nv">$ </span><span class="nb">cd </span>jailkit-2.17
vagrant@debian<span class="nv">$ </span>./configure
vagrant@debian<span class="nv">$ </span>make
vagrant@debian<span class="nv">$ </span>make install
</code></pre></div>
<p>Теперь нам нужна папка для подсистемы:</p>
<div class="highlight"><pre><code class="text language-text" data-lang="text">$ mkdir /home/jail
$ chown root:root /home/jail
</code></pre></div>
<p>Можно начинать наполнение системы. Есть примеры уже готовых конфигов в <a href="/jk_init.html">/etc/jailkit/jk_init.ini</a></p>

<p>пример из документации с пояснениями:</p>
<div class="highlight"><pre><code class="sh language-sh" data-lang="sh"><span class="o">[</span>jk_lsh<span class="o">]</span>
<span class="nv">comment</span> <span class="o">=</span> Jailkit limited shell
<span class="nv">paths</span> <span class="o">=</span> /usr/sbin/jk_lsh, /etc/jailkit/jk_lsh.ini
<span class="nv">users</span> <span class="o">=</span> root
<span class="nv">groups</span> <span class="o">=</span> root
<span class="nv">need_logsocket</span> <span class="o">=</span> 1
<span class="nv">includesections</span> <span class="o">=</span> uidbasics

<span class="o">[</span>sftp<span class="o">]</span>
<span class="nv">comment</span> <span class="o">=</span> ssh secure ftp with Jailkit limited shell
<span class="nv">paths</span> <span class="o">=</span> /usr/lib/sftp-server
<span class="nv">includesections</span> <span class="o">=</span> netbasics, uidbasics
<span class="nv">devices</span> <span class="o">=</span> /dev/urandom, /dev/null
<span class="nv">emptydirs</span> <span class="o">=</span> /svr
</code></pre></div>
<p><code>paths</code> entry specifies which files and directories need to be copied into the jail. Executables and libraries are checked for any required libraries, and these requirements are copied too. All files are created with user root as owner.</p>

<p><code>paths_w_owner</code> entry specifies which paths need to be copied with their current ownership. This can be used to copy files that need to be writable by a server process that does not run as user root (for example database files). The users and groups entries specify which users and groups that need to be present in jail /etc/passwd.</p>

<p><code>need_logsocket</code> entry is set to &quot;1&quot; the jk_socketd.ini file is modified to include a /dev/log socket in this jail.</p>

<p><code>devices</code> entry specifies which devices are required in the jail.</p>

<p><code>includesections</code> entry specifies which other sections need to be processed as well when processing the current section. In the above example, the jk_lsh section is automatically included if the sftp section is processed.</p>

<p><code>emptydirs</code> entry specifies which directories to create as empty directories. This can be useful to create for example mountpoints in the jail.</p>

<h3>Ставим нужные пакеты</h3>

<p>С соответствующими правами:</p>
<div class="highlight"><pre><code class="sh language-sh" data-lang="sh"><span class="nv">$ </span>jk_init -v /home/jail basicshell
<span class="nv">$ </span>jk_init -v /home/jail netutils
<span class="nv">$ </span>jk_init -v /home/jail editors
</code></pre></div>
<h3>Создаем пользователя</h3>
<div class="highlight"><pre><code class="sh language-sh" data-lang="sh"><span class="nv">$ </span>useradd -d /home/jailed_user -m jailed_user -s /bin/bash
<span class="nv">$ </span>passwd jailed_user
</code></pre></div>
<p>После чего мы проверяем <code>/etc/passwd</code>:</p>
<div class="highlight"><pre><code class="sh language-sh" data-lang="sh">jailed_user:x:1001:1001::/home/jail/./home/jailed_user:/usr/sbin/jk_chrootsh
</code></pre></div>
<h3>Теперь прячем его в Jail</h3>

<p>Тут начинается <strong><em>МАГИЯ</em></strong></p>
<div class="highlight"><pre><code class="sh language-sh" data-lang="sh"><span class="nv">$ </span>jk_jailuser -m -j /home/jail jailed_user
</code></pre></div>
<p><code>-m</code> говорит, чтобы скрипт пернес данные пользователя внурть тюрьмы</p>

<p><code>-j</code> указывает в какой именно джейл его сажать</p>

<h3>Дадим нормальную консоль</h3>

<p>проверяем и правим <code>/home/jail/etc/passwd</code></p>
<div class="highlight"><pre><code class="text language-text" data-lang="text">jailed_user:x:1001:1001::/home/jailed_user:/bin/bash
</code></pre></div>
<p>проверяем и правим <code>/home/jail/etc/group</code></p>
<div class="highlight"><pre><code class="text language-text" data-lang="text">jailed_user:x:1001:
</code></pre></div>
<h3>Недостающие папки смело создаем</h3>
<div class="highlight"><pre><code class="sh language-sh" data-lang="sh"><span class="nv">$ </span>mkdir /home/jail/tmp
<span class="nv">$ </span>chmod a+rwx /home/jail/tmp
</code></pre></div><div class="highlight"><pre><code class="text language-text" data-lang="text">$ mkdir /home/jail/opt
</code></pre></div>
<h3>Пытаемся войти</h3>

<p><code>ssh jailed_user@127.0.0.1 -p 2222</code></p>

<p>и если дело валится то смотрим</p>

<p><code>cat /var/log/auth.log</code></p>

        </section>

        <footer>
            Jailkit Quickstart is maintained by <a href="https://github.com/prikha">prikha</a><br>
            Tactile theme by <a href="https://twitter.com/jasonlong">Jason Long</a>.
        </footer>


    </div>
</div>
</body>
</html>